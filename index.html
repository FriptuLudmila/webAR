<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <!-- Critical mobile viewport settings for AR -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <title>AR.js Mobile - Custom 3D Model with Interactions</title>
    
    <!-- A-Frame and AR.js libraries for WebAR functionality -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>
    
    <style>
        /* Critical mobile-first styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', Arial, sans-serif;
            /* Prevent mobile browser bouncing */
            position: fixed;
            touch-action: none;
        }
        
        /* Ensure scene takes full viewport on mobile */
        a-scene {
            position: fixed !important;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        /* UI Overlay optimized for mobile */
        #ui-overlay {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px;
            border-radius: 10px;
            font-size: 12px;
            text-align: center;
            z-index: 999;
            /* Allow touch events on buttons only */
            pointer-events: auto;
            /* Prevent text selection on mobile */
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Compact title for mobile */
        #ui-overlay h3 {
            margin: 0 0 8px 0;
            color: #4CAF50;
            font-size: 14px;
        }
        
        /* Status indicator for mobile */
        #status {
            color: #ffcc00;
            margin: 8px 0;
            font-weight: bold;
            padding: 4px;
            border-radius: 4px;
            background: rgba(255,204,0,0.2);
            font-size: 11px;
        }
        
        #status.active {
            color: #4CAF50;
            background: rgba(76,175,80,0.2);
        }
        
        /* Mobile-optimized instructions */
        .instructions {
            text-align: left;
            margin: 8px 0;
            font-size: 11px;
            line-height: 1.4;
        }
        
        /* Loading screen for mobile */
        .arjs-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .arjs-loader div {
            text-align: center;
            font-size: 1.2em;
            color: white;
            margin: 10px;
            padding: 0 20px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Touch-friendly button */
        .marker-button {
            display: inline-block;
            margin-top: 8px;
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            font-size: 12px;
        }
        
        /* Hide elements that might interfere on mobile */
        .a-enter-vr {
            display: none !important;
        }
        
        /* Ensure video fills screen on mobile */
        video {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            min-width: 100% !important;
            min-height: 100% !important;
            width: auto !important;
            height: auto !important;
        }
    </style>
</head>
<body>
    
    <!-- Loading screen shown while AR initializes -->
    <div class="arjs-loader">
        <div class="spinner"></div>
        <div>Initializing Camera...</div>
        <div style="font-size: 0.9em; opacity: 0.8;">Please allow camera access</div>
    </div>
    
    <!-- Mobile-optimized UI Overlay -->
    <div id="ui-overlay">
        <h3>üì± AR.js Mobile Demo</h3>
        <div class="instructions">
            <strong>Quick Guide:</strong><br>
            ‚Ä¢ Point at HIRO marker<br>
            ‚Ä¢ TAP model = change color<br>
            ‚Ä¢ DOUBLE TAP = hide/show
        </div>
        <div id="status">üîç Searching for marker...</div>
        <a href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png" 
           target="_blank" 
           class="marker-button">
           Get HIRO Marker
        </a>
    </div>

    <!-- Mobile-optimized AR Scene -->
    <a-scene
        embedded
        arjs="sourceType: webcam; 
              sourceWidth: 1280; 
              sourceHeight: 960; 
              displayWidth: 1280; 
              displayHeight: 960; 
              debugUIEnabled: false; 
              detectionMode: mono_and_matrix; 
              matrixCodeType: 3x3;
              trackingMethod: best;
              patternRatio: 0.75;
              maxDetectionRate: 60;
              smooth: true;
              smoothCount: 5;
              smoothTolerance: 0.01;
              smoothThreshold: 5;"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; 
                  precision: medium; 
                  antialias: true; 
                  alpha: true;
                  colorManagement: true;
                  physicallyCorrectLights: true;">
        
        <!-- Asset Management -->
        <a-assets timeout="10000">
            <!-- Using a simpler, lighter model for mobile performance -->
            <!-- Alternative: Using a primitive first, then loading model -->
        </a-assets>

        <!-- Optimized Lighting for Mobile -->
        <a-light type="ambient" color="#ffffff" intensity="1.0"></a-light>
        <a-light type="directional" color="#ffffff" intensity="0.5" position="-1 2 1"></a-light>

        <!-- HIRO Marker with mobile-optimized settings -->
        <a-marker 
            id="hiro-marker"
            preset="hiro"
            raycaster="objects: .clickable; far: 1000"
            emitevents="true"
            cursor="rayOrigin: mouse"
            smooth="true"
            smoothCount="10"
            smoothTolerance="0.01"
            smoothThreshold="5">
            
            <!-- 3D Content Container -->
            <a-entity id="3d-content">
                
                <!-- Using primitive geometry for better mobile performance -->
                <!-- This loads faster and more reliably on mobile -->
                <a-entity id="model-container" position="0 0 0">
                    
                    <!-- Main interactive object: Animated Torus Knot -->
                    <a-torus-knot
                        id="main-model"
                        class="clickable"
                        position="0 0.5 0"
                        radius="0.3"
                        radius-tubular="0.05"
                        segments-tubular="32"
                        segments-radial="16"
                        material="color: #4CC3D9; metalness: 0.5; roughness: 0.3"
                        scale="1 1 1"
                        animation="property: rotation; to: 0 360 0; loop: true; dur: 6000; easing: linear"
                        animation__bob="property: position; from: 0 0.5 0; to: 0 0.8 0; dir: alternate; loop: true; dur: 2000; easing: easeInOutSine"
                        animation__pulse="property: scale; from: 1 1 1; to: 1.1 1.1 1.1; dir: alternate; loop: true; dur: 1500">
                    </a-torus-knot>
                    
                    <!-- Secondary animated element -->
                    <a-octahedron
                        position="0.8 0.5 0"
                        radius="0.2"
                        material="color: #FFD700; metalness: 0.7; roughness: 0.2"
                        animation="property: rotation; to: 360 0 0; loop: true; dur: 3000">
                    </a-octahedron>
                    
                    <!-- Third animated element -->
                    <a-tetrahedron
                        position="-0.8 0.5 0"
                        radius="0.2"
                        material="color: #FF6B6B; metalness: 0.6; roughness: 0.3"
                        animation="property: rotation; to: 0 0 360; loop: true; dur: 4000">
                    </a-tetrahedron>
                    
                </a-entity>
                
                <!-- Floating Text -->
                <a-text
                    id="ar-text"
                    value="TAP ME!"
                    position="0 1.3 0"
                    align="center"
                    color="#FFFFFF"
                    width="4"
                    font="kelsonsans">
                </a-text>
                
                <!-- Ground plane for reference -->
                <a-circle
                    position="0 0 0"
                    rotation="-90 0 0"
                    radius="1"
                    material="color: #7BC8A4; opacity: 0.4; transparent: true">
                </a-circle>
                
            </a-entity>
            
        </a-marker>

        <!-- Camera with mobile-specific settings -->
        <a-entity camera></a-entity>
        
    </a-scene>

    <script>
        // Mobile-optimized initialization
        function initAR() {
            const scene = document.querySelector('a-scene');
            const loader = document.querySelector('.arjs-loader');
            const statusText = document.getElementById('status');
            const marker = document.getElementById('hiro-marker');
            const mainModel = document.getElementById('main-model');
            const arText = document.getElementById('ar-text');
            
            // State management
            let markerVisible = false;
            let modelVisible = true;
            let lastTapTime = 0;
            
            // Mobile-friendly color palette
            const colors = ['#4CC3D9', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFD700', '#96CEB4', '#DDA0DD', '#FF69B4'];
            let currentColorIndex = 0;
            
            // Hide loader with delay for mobile
            function hideLoader() {
                setTimeout(() => {
                    loader.style.display = 'none';
                    console.log('‚úÖ AR scene ready');
                }, 1500);
            }
            
            // Wait for scene to be fully loaded
            if (scene.hasLoaded) {
                hideLoader();
            } else {
                scene.addEventListener('loaded', hideLoader);
            }
            
            // MARKER DETECTION EVENTS
            marker.addEventListener('markerFound', () => {
                console.log('‚úÖ Marker found');
                statusText.textContent = '‚úÖ Marker Detected!';
                statusText.className = 'active';
                markerVisible = true;
                arText.setAttribute('value', 'TAP ME!');
                
                // Vibrate on mobile when marker found (if supported)
                if (navigator.vibrate) {
                    navigator.vibrate(100);
                }
            });
            
            marker.addEventListener('markerLost', () => {
                console.log('‚ùå Marker lost');
                statusText.textContent = 'üîç Searching for marker...';
                statusText.className = '';
                markerVisible = false;
            });
            
            // MOBILE TOUCH INTERACTION
            // Using touch events for better mobile support
            function handleInteraction(event) {
                if (!markerVisible) return;
                
                // Prevent default touch behavior
                event.preventDefault();
                event.stopPropagation();
                
                const currentTime = Date.now();
                const timeSinceLastTap = currentTime - lastTapTime;
                
                // Detect double tap (within 300ms for mobile)
                if (timeSinceLastTap < 300) {
                    // DOUBLE TAP: Toggle visibility
                    modelVisible = !modelVisible;
                    mainModel.setAttribute('visible', modelVisible);
                    arText.setAttribute('value', modelVisible ? 'VISIBLE!' : 'HIDDEN!');
                    console.log(`Visibility: ${modelVisible}`);
                    
                    // Haptic feedback
                    if (navigator.vibrate) {
                        navigator.vibrate([50, 50, 50]);
                    }
                } else {
                    // SINGLE TAP: Change color
                    currentColorIndex = (currentColorIndex + 1) % colors.length;
                    const newColor = colors[currentColorIndex];
                    
                    mainModel.setAttribute('material', 'color', newColor);
                    arText.setAttribute('value', `COLOR ${currentColorIndex + 1}`);
                    console.log(`Color: ${newColor}`);
                    
                    // Quick vibration feedback
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                }
                
                lastTapTime = currentTime;
            }
            
            // Add both click and touch listeners for maximum compatibility
            mainModel.addEventListener('click', handleInteraction);
            
            // Add touch event listeners to the scene for mobile
            scene.addEventListener('touchstart', (event) => {
                // Check if we're touching over the marker area
                if (markerVisible) {
                    handleInteraction(event);
                }
            });
            
            // Mobile-specific camera handling
            function initCamera() {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 960 }
                    }
                };
                
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(stream => {
                        console.log('üì∑ Camera initialized');
                        // Don't stop the stream - AR.js needs it
                    })
                    .catch(err => {
                        console.error('Camera error:', err);
                        statusText.textContent = '‚ùå Camera access needed';
                        statusText.style.color = '#ff4444';
                        
                        // Try again with basic constraints
                        navigator.mediaDevices.getUserMedia({ video: true })
                            .then(() => console.log('üì∑ Basic camera OK'))
                            .catch(() => console.error('Camera failed completely'));
                    });
            }
            
            // Initialize camera after a short delay
            setTimeout(initCamera, 500);
            
            // Mobile performance optimization
            // Reduce quality on low-end devices
            if (window.devicePixelRatio > 2) {
                scene.setAttribute('renderer', 'pixelRatio', 2);
            }
            
            // Log initialization
            console.log('üì± Mobile AR initialized');
            console.log('Using touch events for interaction');
        }
        
        // Start AR when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAR);
        } else {
            initAR();
        }
        
        // Prevent zoom on double tap (iOS)
        document.addEventListener('touchend', (event) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // Handle orientation changes
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                window.scrollTo(0, 0);
            }, 500);
        });
    </script>

</body>
</html>